@using DevelopmentMetrics.Cards
@model DevelopmentMetrics.Website.Models.CardsViewModel
@{
    ViewBag.Title = "Cards";

    var @metrics = @Model.GetCardCountByStatus();
}

<script type="text/javascript" src="https://www.google.com/jsapi"> </script>

<div class="row">
    <h2>Card metrics</h2>
</div>
<div class="row">
    <div class="col-md-3">
        <h4>
            Lead time (in days): @Model.CalculateLeadTime()
        </h4>
    </div>
    <div class="col-md-3">
        <h4>
            Todo: @metrics[CardStatus.Status.Todo]
        </h4>
    </div>
    <div class="col-md-3">
        <h4>
            In process: @metrics[CardStatus.Status.Doing]
        </h4>
    </div>
    <div class="col-md-3">
        <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" id="menu1" type="button" data-toggle="dropdown">
                Chart data
                <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" role="menu" aria-labelledby="menu1">
                <li role="presentation"><a role="menuitem" tabindex="-1" href="javascript: drawChart(42);">6 weeks (default)</a></li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="javascript: drawChart(49);">7 weeks</a></li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="javascript: drawChart(56);">8 weeks</a></li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="javascript: drawChart(63);">9 weeks</a></li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="javascript: drawChart(70);">10 weeks</a></li>
                <li role="presentation"><a role="menuitem" tabindex="-1" href="javascript: drawChart(140);">20 weeks</a></li>
            </ul>
        </div>
    </div>
</div>

<div class="row">
    <div id="CardChart" class="chartWrapper"></div>
</div>

<div class="row">
    <h4>Cards in process (@metrics[CardStatus.Status.Doing]):</h4>
    @foreach (var card in Model.GetCardsInProcess())
    {
        <div class="col-lg-3">
            @card.Title
        </div>
    }
</div>

<script type="text/javascript">
    google.load("visualization", "1",
        {
            packages: ["corechart"]
        });

    google.setOnLoadCallback(drawChart);

    function drawChart(days) {
        var chartDays = 42;

        if (days && typeof days == "number") {
            chartDays = days;
        };

        $.ajax({
            url: '@Url.Action("GetCardCountByDay","Cards")',
            dataType: "json",
            data: {
                numberOfDays: chartDays
            },
            type: "POST",
            error: function (xhr, status, error) {
                var err = eval("(" + xhr.responseText + ")");

                showChartMessage(err.message);
            },
            beforeSend: function () {
                showChartLoading();
            },
            success: function (data) {
                renderChartData(data);
            },
            complete: function () {
                hideChartLoading();
            }
        });

        return false;
    };

    function showChartMessage(msg) {
        var cardChart = $("#CardChart");

        cardChart.text(msg);
    }

    function showChartLoading() {
        var cardChart = $("#CardChart");

        cardChart.addClass("loading");

        showChartMessage("Loading");
    }

    function hideChartLoading() {
        var cardChart = $("#CardChart");

        cardChart.removeClass("loading").addClass("loaded");
    }

    function renderChartData(data) {
        var dataTable = new google.visualization.DataTable();
        dataTable.addColumn('date', 'day');
        dataTable.addColumn('number', 'Done');
        dataTable.addColumn('number', 'Total');

        $.each(data,
            function (i, item) {
                dataTable.addRows([[new Date(getDateIfDate(item.Date)), item.DoneTotal, item.Total]]);
            });

        var minValue = dataTable.getFormattedValue(0, 2) - 30;

        var options = {
            title: 'Cumulative flow diagram',
            titleTextStyle: {
                italic: false,
                color: '#00BBF1',
                fontSize: '20'
            },
            height: 600,
            pointSize: 3,
            curveType: 'function',
            chartArea: {
                top: 50
            },
            legend:
            {
                position: 'bottom',
                textStyle:
                {
                    color: '#666'
                }
            },
            colors: ['#34A853', 'ff6600', '#FBBC05'],
            hAxis:
            {
                title: 'Time (days)',
                titleTextStyle:
                {
                    italic: false,
                    color: '#00BBF1',
                    fontSize: '20'
                },
                textStyle:
                {
                    color: '#666'
                },
                format: 'dd MMM'
            },
            vAxis:
            {
                baselineColor: '#f5f5f5',
                title: 'Number of items',
                titleTextStyle:
                {
                    color: '#00BBF1',
                    italic: false,
                    fontSize: '20'
                },
                textStyle:
                {
                    color: '#666'
                },
                viewWindow:
                {
                    min: minValue,
                    format: 'long'
                }
            }
        };
        var chart = new google.visualization.LineChart(document.getElementById('CardChart'));
        chart.draw(dataTable, options);

        return false;
    }

    function getDateIfDate(d) {
        var m = d.match(/\/Date\((\d+)\)\//);
        return m
            ? (new Date(+m[1])).toString('dd/MM/yyyy')
            : d;
    };
</script>
